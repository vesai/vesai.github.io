<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <style>
    .installApp {
      display: none;
    }
    .installApp_visible {
      display: block;
    }
  </style>
</head>
<body>
  <button class="installApp">Install App</button>
  <button class="cameraButton">Проверить доступ к камере</button>
  <video class="videoPreview" muted></video>
  <script>
   if ('serviceWorker' in navigator) {
     window.addEventListener('load', () => {
       navigator.serviceWorker.register('/service-worker.js').then(registration => {
         console.log('SW registered: ', registration);
       }).catch(registrationError => {
         console.log('SW registration failed: ', registrationError);
       });
     });
   }
    
    var deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      deferredPrompt = e;
      // Update UI notify the user they can install the PWA
      const button = document.querySelector('.installApp');
      button.classList.add('installApp_visible');
      button.addEventListener('click', () => {
        if(deferredPrompt !== undefined) {
          // The user has had a postive interaction with our app and Chrome
          // has tried to prompt previously, so let's show the prompt.
          deferredPrompt.prompt();

          // Follow what the user has done with the prompt.
          deferredPrompt.userChoice.then(function(choiceResult) {

            console.log(choiceResult.outcome);

            if(choiceResult.outcome == 'dismissed') {
              console.log('User cancelled home screen install');
            }
            else {
              console.log('User added to home screen');
            }

            // We no longer need the prompt.  Clear it up.
            deferredPrompt = null;
          });
        }
      });
    });
    
    document.querySelector('.cameraButton').addEventListener('click', () => {
      navigator.mediaDevices.getUserMedia({ video: true }).then(
        localMediaStream => {
          const element = document.querySelector('.videoPreview');
          
          try {
                const streamUrl = URL.createObjectURL(localMediaStream);
                element.src = streamUrl;
                element.play();
                return () => {
                    URL.revokeObjectURL(streamUrl);
                };
            } catch {
                element.srcObject = localMediaStream;
                element.play();
            }
        }
      );
    });
  </script>
</body>
</html>
